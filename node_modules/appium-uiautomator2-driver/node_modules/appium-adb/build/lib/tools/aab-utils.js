"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _logger = _interopRequireDefault(require("../logger.js"));
var _path = _interopRequireDefault(require("path"));
var _support = require("@appium/support");
var _lruCache = _interopRequireDefault(require("lru-cache"));
var _helpers = require("../helpers.js");
var _asyncLock = _interopRequireDefault(require("async-lock"));
var _bluebird = _interopRequireDefault(require("bluebird"));
var _crypto = _interopRequireDefault(require("crypto"));
const AAB_CACHE = new _lruCache.default({
  max: 10,
  dispose: (hash, extractedFilesRoot) => _support.fs.rimraf(extractedFilesRoot)
});
const AAB_CACHE_GUARD = new _asyncLock.default();
const UNIVERSAL_APK = 'universal.apk';
const aabUtilsMethods = {};
process.on('exit', () => {
  if (!AAB_CACHE.size) {
    return;
  }
  const paths = [...AAB_CACHE.values()];
  _logger.default.debug(`Performing cleanup of ${paths.length} cached .aab ` + _support.util.pluralize('package', paths.length));
  for (const appPath of paths) {
    try {
      _support.fs.rimrafSync(appPath);
    } catch (e) {
      _logger.default.warn(e.message);
    }
  }
});
aabUtilsMethods.extractUniversalApk = async function extractUniversalApk(aabPath, opts = {}) {
  if (!(await _support.fs.exists(aabPath))) {
    throw new Error(`The file at '${aabPath}' either does not exist or is not accessible`);
  }
  const aabName = _path.default.basename(aabPath);
  const apkName = aabName.substring(0, aabName.length - _path.default.extname(aabName).length) + '.apk';
  const tmpRoot = await _support.tempDir.openDir();
  const tmpApksPath = _path.default.join(tmpRoot, `${aabName}.apks`);
  try {
    return await AAB_CACHE_GUARD.acquire(aabPath, async () => {
      const aabHash = await _support.fs.hash(aabPath);
      const {
        keystore,
        keystorePassword,
        keyAlias,
        keyPassword
      } = opts;
      let cacheHash = aabHash;
      if (keystore) {
        if (!(await _support.fs.exists(keystore))) {
          throw new Error(`The keystore file at '${keystore}' either does not exist ` + `or is not accessible`);
        }
        if (!keystorePassword || !keyAlias || !keyPassword) {
          throw new Error('It is mandatory to also provide keystore password, key alias, ' + 'and key password if the keystore path is set');
        }
        const keystoreHash = await _support.fs.hash(keystore);
        const keyAliasHash = _crypto.default.createHash('sha1');
        keyAliasHash.update(keyAlias);
        cacheHash = [cacheHash, keystoreHash, keyAliasHash.digest('hex')].join(':');
      }
      _logger.default.debug(`Calculated the cache key for '${aabPath}': ${cacheHash}`);
      if (AAB_CACHE.has(cacheHash)) {
        const resultPath = _path.default.resolve(AAB_CACHE.get(cacheHash), apkName);
        if (await _support.fs.exists(resultPath)) {
          return resultPath;
        }
        AAB_CACHE.del(cacheHash);
      }
      await this.initAapt2();
      const args = ['build-apks', '--aapt2', this.binaries.aapt2, '--bundle', aabPath, '--output', tmpApksPath, ...(keystore ? ['--ks', keystore, '--ks-pass', `pass:${keystorePassword}`, '--ks-key-alias', keyAlias, '--key-pass', `pass:${keyPassword}`] : []), '--mode=universal'];
      _logger.default.debug(`Preparing universal .apks bundle from '${aabPath}'`);
      await this.execBundletool(args, `Cannot build a universal .apks bundle from '${aabPath}'`);
      _logger.default.debug(`Unpacking universal application bundle at '${tmpApksPath}' to '${tmpRoot}'`);
      await (0, _helpers.unzipFile)(tmpApksPath, tmpRoot);
      let universalApkPath;
      const fileDeletionPromises = [];
      const allFileNames = await _support.fs.readdir(tmpRoot);
      for (const fileName of allFileNames) {
        const fullPath = _path.default.join(tmpRoot, fileName);
        if (fileName === UNIVERSAL_APK) {
          universalApkPath = fullPath;
        } else {
          fileDeletionPromises.push(_support.fs.rimraf(fullPath));
        }
      }
      try {
        await _bluebird.default.all(fileDeletionPromises);
      } catch (ign) {}
      if (!universalApkPath) {
        _logger.default.debug(`The following items were extracted from the .aab bundle: ${allFileNames}`);
        throw new Error(`${UNIVERSAL_APK} cannot be found in '${aabPath}' bundle. ` + `Does the archive contain a valid application bundle?`);
      }
      const resultPath = _path.default.join(tmpRoot, apkName);
      _logger.default.debug(`Found ${UNIVERSAL_APK} at '${universalApkPath}'. Caching it to '${resultPath}'`);
      await _support.fs.mv(universalApkPath, resultPath);
      AAB_CACHE.set(cacheHash, tmpRoot);
      return resultPath;
    });
  } catch (e) {
    await _support.fs.rimraf(tmpRoot);
    throw e;
  }
};
var _default = aabUtilsMethods;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBQUJfQ0FDSEUiLCJMUlUiLCJtYXgiLCJkaXNwb3NlIiwiaGFzaCIsImV4dHJhY3RlZEZpbGVzUm9vdCIsImZzIiwicmltcmFmIiwiQUFCX0NBQ0hFX0dVQVJEIiwiQXN5bmNMb2NrIiwiVU5JVkVSU0FMX0FQSyIsImFhYlV0aWxzTWV0aG9kcyIsInByb2Nlc3MiLCJvbiIsInNpemUiLCJwYXRocyIsInZhbHVlcyIsImxvZyIsImRlYnVnIiwibGVuZ3RoIiwidXRpbCIsInBsdXJhbGl6ZSIsImFwcFBhdGgiLCJyaW1yYWZTeW5jIiwiZSIsIndhcm4iLCJtZXNzYWdlIiwiZXh0cmFjdFVuaXZlcnNhbEFwayIsImFhYlBhdGgiLCJvcHRzIiwiZXhpc3RzIiwiRXJyb3IiLCJhYWJOYW1lIiwicGF0aCIsImJhc2VuYW1lIiwiYXBrTmFtZSIsInN1YnN0cmluZyIsImV4dG5hbWUiLCJ0bXBSb290IiwidGVtcERpciIsIm9wZW5EaXIiLCJ0bXBBcGtzUGF0aCIsImpvaW4iLCJhY3F1aXJlIiwiYWFiSGFzaCIsImtleXN0b3JlIiwia2V5c3RvcmVQYXNzd29yZCIsImtleUFsaWFzIiwia2V5UGFzc3dvcmQiLCJjYWNoZUhhc2giLCJrZXlzdG9yZUhhc2giLCJrZXlBbGlhc0hhc2giLCJjcnlwdG8iLCJjcmVhdGVIYXNoIiwidXBkYXRlIiwiZGlnZXN0IiwiaGFzIiwicmVzdWx0UGF0aCIsInJlc29sdmUiLCJnZXQiLCJkZWwiLCJpbml0QWFwdDIiLCJhcmdzIiwiYmluYXJpZXMiLCJhYXB0MiIsImV4ZWNCdW5kbGV0b29sIiwidW56aXBGaWxlIiwidW5pdmVyc2FsQXBrUGF0aCIsImZpbGVEZWxldGlvblByb21pc2VzIiwiYWxsRmlsZU5hbWVzIiwicmVhZGRpciIsImZpbGVOYW1lIiwiZnVsbFBhdGgiLCJwdXNoIiwiQiIsImFsbCIsImlnbiIsIm12Iiwic2V0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL3Rvb2xzL2FhYi11dGlscy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlci5qcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCB1dGlsIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCBMUlUgZnJvbSAnbHJ1LWNhY2hlJztcbmltcG9ydCB7IHVuemlwRmlsZSB9IGZyb20gJy4uL2hlbHBlcnMuanMnO1xuaW1wb3J0IEFzeW5jTG9jayBmcm9tICdhc3luYy1sb2NrJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcblxuY29uc3QgQUFCX0NBQ0hFID0gbmV3IExSVSh7XG4gIG1heDogMTAsXG4gIGRpc3Bvc2U6IChoYXNoLCBleHRyYWN0ZWRGaWxlc1Jvb3QpID0+IGZzLnJpbXJhZihleHRyYWN0ZWRGaWxlc1Jvb3QpLFxufSk7XG5jb25zdCBBQUJfQ0FDSEVfR1VBUkQgPSBuZXcgQXN5bmNMb2NrKCk7XG5jb25zdCBVTklWRVJTQUxfQVBLID0gJ3VuaXZlcnNhbC5hcGsnO1xuXG5jb25zdCBhYWJVdGlsc01ldGhvZHMgPSB7fTtcblxucHJvY2Vzcy5vbignZXhpdCcsICgpID0+IHtcbiAgaWYgKCFBQUJfQ0FDSEUuc2l6ZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHBhdGhzID0gWy4uLkFBQl9DQUNIRS52YWx1ZXMoKV07XG4gIGxvZy5kZWJ1ZyhgUGVyZm9ybWluZyBjbGVhbnVwIG9mICR7cGF0aHMubGVuZ3RofSBjYWNoZWQgLmFhYiBgICtcbiAgICB1dGlsLnBsdXJhbGl6ZSgncGFja2FnZScsIHBhdGhzLmxlbmd0aCkpO1xuICBmb3IgKGNvbnN0IGFwcFBhdGggb2YgcGF0aHMpIHtcbiAgICB0cnkge1xuICAgICAgLy8gQXN5bmNocm9ub3VzIGNhbGxzIGFyZSBub3Qgc3VwcG9ydGVkIGluIG9uRXhpdCBoYW5kbGVyXG4gICAgICBmcy5yaW1yYWZTeW5jKGFwcFBhdGgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy53YXJuKGUubWVzc2FnZSk7XG4gICAgfVxuICB9XG59KTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBBcGtDcmVhdGlvbk9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBrZXlzdG9yZSBTcGVjaWZpZXMgdGhlIHBhdGggdG8gdGhlIGRlcGxveW1lbnQga2V5c3RvcmUgdXNlZFxuICogdG8gc2lnbiB0aGUgQVBLcy4gVGhpcyBmbGFnIGlzIG9wdGlvbmFsLiBJZiB5b3UgZG9uJ3QgaW5jbHVkZSBpdCxcbiAqIGJ1bmRsZXRvb2wgYXR0ZW1wdHMgdG8gc2lnbiB5b3VyIEFQS3Mgd2l0aCBhIGRlYnVnIHNpZ25pbmcga2V5LlxuICogSWYgdGhlIC5hcGsgaGFzIGJlZW4gYWxyZWFkeSBzaWduZWQgYW5kIGNhY2hlZCB0aGVuIGl0IGlzIG5vdCBnb2luZyB0byBiZSByZXNpZ25lZFxuICogdW5sZXNzIGEgZGlmZmVyZW50IGtleXN0b3JlIG9yIGtleSBhbGlhcyBpcyB1c2VkLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGtleXN0b3JlUGFzc3dvcmQgU3BlY2lmaWVzIHlvdXIga2V5c3RvcmXigJlzIHBhc3N3b3JkLlxuICogSXQgaXMgbWFuZGF0b3J5IHRvIHByb3ZpZGUgdGhpcyB2YWx1ZSBpZiBga2V5c3RvcmVgIG9uZSBpcyBhc3NpZ25lZFxuICogb3RoZXJ3aXNlIGl0IGlzIGdvaW5nIHRvIGJlIGlnbm9yZWQuXG4gKiBAcHJvcGVydHkge3N0cmluZ30ga2V5QWxpYXMgU3BlY2lmaWVzIHRoZSBhbGlhcyBvZiB0aGUgc2lnbmluZyBrZXkgeW91IHdhbnQgdG8gdXNlLlxuICogSXQgaXMgbWFuZGF0b3J5IHRvIHByb3ZpZGUgdGhpcyB2YWx1ZSBpZiBga2V5c3RvcmVgIG9uZSBpcyBhc3NpZ25lZFxuICogb3RoZXJ3aXNlIGl0IGlzIGdvaW5nIHRvIGJlIGlnbm9yZWQuXG4gKiBAcHJvcGVydHkge3N0cmluZ30ga2V5UGFzc3dvcmQgU3BlY2lmaWVzIHRoZSBwYXNzd29yZCBmb3IgdGhlIHNpZ25pbmcga2V5LlxuICogSXQgaXMgbWFuZGF0b3J5IHRvIHByb3ZpZGUgdGhpcyB2YWx1ZSBpZiBga2V5c3RvcmVgIG9uZSBpcyBhc3NpZ25lZFxuICogb3RoZXJ3aXNlIGl0IGlzIGdvaW5nIHRvIGJlIGlnbm9yZWQuXG4gKi9cblxuLyoqXG4gKiBCdWlsZHMgYSB1bml2ZXJzYWwgLmFwayBmcm9tIHRoZSBnaXZlbiAuYWFiIHBhY2thZ2UuIFNlZVxuICogaHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vc3R1ZGlvL2NvbW1hbmQtbGluZS9idW5kbGV0b29sI2dlbmVyYXRlX2Fwa3NcbiAqIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFhYlBhdGggRnVsbCBwYXRoIHRvIHRoZSBzb3VyY2UgLmFhYiBwYWNrYWdlXG4gKiBAcGFyYW0ge0Fwa0NyZWF0aW9uT3B0aW9uc30gb3B0c1xuICogQHJldHVybnMgVGhlIHBhdGggdG8gdGhlIHJlc3VsdGluZyB1bml2ZXJzYWwgLmFway4gVGhlIC5hcGsgaXMgc3RvcmVkIGluIHRoZSBpbnRlcm5hbCBjYWNoZVxuICogYnkgZGVmYXVsdC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgY3JlYXRpbmcgdGhlIHVuaXZlcnNhbCAuYXBrXG4gKi9cbmFhYlV0aWxzTWV0aG9kcy5leHRyYWN0VW5pdmVyc2FsQXBrID0gYXN5bmMgZnVuY3Rpb24gZXh0cmFjdFVuaXZlcnNhbEFwayAoYWFiUGF0aCwgb3B0cyA9IHt9KSB7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGFhYlBhdGgpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgZmlsZSBhdCAnJHthYWJQYXRofScgZWl0aGVyIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gIH1cblxuICBjb25zdCBhYWJOYW1lID0gcGF0aC5iYXNlbmFtZShhYWJQYXRoKTtcbiAgY29uc3QgYXBrTmFtZSA9IGFhYk5hbWUuc3Vic3RyaW5nKDAsIGFhYk5hbWUubGVuZ3RoIC0gcGF0aC5leHRuYW1lKGFhYk5hbWUpLmxlbmd0aCkgKyAnLmFwayc7XG4gIGNvbnN0IHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgY29uc3QgdG1wQXBrc1BhdGggPSBwYXRoLmpvaW4odG1wUm9vdCwgYCR7YWFiTmFtZX0uYXBrc2ApO1xuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBBQUJfQ0FDSEVfR1VBUkQuYWNxdWlyZShhYWJQYXRoLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhYWJIYXNoID0gYXdhaXQgZnMuaGFzaChhYWJQYXRoKTtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAga2V5c3RvcmUsXG4gICAgICAgIGtleXN0b3JlUGFzc3dvcmQsXG4gICAgICAgIGtleUFsaWFzLFxuICAgICAgICBrZXlQYXNzd29yZCxcbiAgICAgIH0gPSBvcHRzO1xuICAgICAgbGV0IGNhY2hlSGFzaCA9IGFhYkhhc2g7XG4gICAgICBpZiAoa2V5c3RvcmUpIHtcbiAgICAgICAgaWYgKCFhd2FpdCBmcy5leGlzdHMoa2V5c3RvcmUpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUga2V5c3RvcmUgZmlsZSBhdCAnJHtrZXlzdG9yZX0nIGVpdGhlciBkb2VzIG5vdCBleGlzdCBgICtcbiAgICAgICAgICAgIGBvciBpcyBub3QgYWNjZXNzaWJsZWApO1xuICAgICAgICB9XG4gICAgICAgIGlmICgha2V5c3RvcmVQYXNzd29yZCB8fCAha2V5QWxpYXMgfHwgIWtleVBhc3N3b3JkKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJdCBpcyBtYW5kYXRvcnkgdG8gYWxzbyBwcm92aWRlIGtleXN0b3JlIHBhc3N3b3JkLCBrZXkgYWxpYXMsICcgK1xuICAgICAgICAgICAgJ2FuZCBrZXkgcGFzc3dvcmQgaWYgdGhlIGtleXN0b3JlIHBhdGggaXMgc2V0Jyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qga2V5c3RvcmVIYXNoID0gYXdhaXQgZnMuaGFzaChrZXlzdG9yZSk7XG4gICAgICAgIGNvbnN0IGtleUFsaWFzSGFzaCA9IGNyeXB0by5jcmVhdGVIYXNoKCdzaGExJyk7XG4gICAgICAgIGtleUFsaWFzSGFzaC51cGRhdGUoa2V5QWxpYXMpO1xuICAgICAgICBjYWNoZUhhc2ggPSBbY2FjaGVIYXNoLCBrZXlzdG9yZUhhc2gsIGtleUFsaWFzSGFzaC5kaWdlc3QoJ2hleCcpXS5qb2luKCc6Jyk7XG4gICAgICB9XG4gICAgICBsb2cuZGVidWcoYENhbGN1bGF0ZWQgdGhlIGNhY2hlIGtleSBmb3IgJyR7YWFiUGF0aH0nOiAke2NhY2hlSGFzaH1gKTtcbiAgICAgIGlmIChBQUJfQ0FDSEUuaGFzKGNhY2hlSGFzaCkpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0UGF0aCA9IHBhdGgucmVzb2x2ZShBQUJfQ0FDSEUuZ2V0KGNhY2hlSGFzaCksIGFwa05hbWUpO1xuICAgICAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKHJlc3VsdFBhdGgpKSB7XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdFBhdGg7XG4gICAgICAgIH1cbiAgICAgICAgQUFCX0NBQ0hFLmRlbChjYWNoZUhhc2gpO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLmluaXRBYXB0MigpO1xuICAgICAgY29uc3QgYXJncyA9IFtcbiAgICAgICAgJ2J1aWxkLWFwa3MnLFxuICAgICAgICAnLS1hYXB0MicsIHRoaXMuYmluYXJpZXMuYWFwdDIsXG4gICAgICAgICctLWJ1bmRsZScsIGFhYlBhdGgsXG4gICAgICAgICctLW91dHB1dCcsIHRtcEFwa3NQYXRoLFxuICAgICAgICAuLi4oa2V5c3RvcmUgPyBbXG4gICAgICAgICAgJy0ta3MnLCBrZXlzdG9yZSxcbiAgICAgICAgICAnLS1rcy1wYXNzJywgYHBhc3M6JHtrZXlzdG9yZVBhc3N3b3JkfWAsXG4gICAgICAgICAgJy0ta3Mta2V5LWFsaWFzJywga2V5QWxpYXMsXG4gICAgICAgICAgJy0ta2V5LXBhc3MnLCBgcGFzczoke2tleVBhc3N3b3JkfWAsXG4gICAgICAgIF0gOiBbXSksXG4gICAgICAgICctLW1vZGU9dW5pdmVyc2FsJ1xuICAgICAgXTtcbiAgICAgIGxvZy5kZWJ1ZyhgUHJlcGFyaW5nIHVuaXZlcnNhbCAuYXBrcyBidW5kbGUgZnJvbSAnJHthYWJQYXRofSdgKTtcbiAgICAgIGF3YWl0IHRoaXMuZXhlY0J1bmRsZXRvb2woYXJncywgYENhbm5vdCBidWlsZCBhIHVuaXZlcnNhbCAuYXBrcyBidW5kbGUgZnJvbSAnJHthYWJQYXRofSdgKTtcblxuICAgICAgbG9nLmRlYnVnKGBVbnBhY2tpbmcgdW5pdmVyc2FsIGFwcGxpY2F0aW9uIGJ1bmRsZSBhdCAnJHt0bXBBcGtzUGF0aH0nIHRvICcke3RtcFJvb3R9J2ApO1xuICAgICAgYXdhaXQgdW56aXBGaWxlKHRtcEFwa3NQYXRoLCB0bXBSb290KTtcbiAgICAgIGxldCB1bml2ZXJzYWxBcGtQYXRoO1xuICAgICAgY29uc3QgZmlsZURlbGV0aW9uUHJvbWlzZXMgPSBbXTtcbiAgICAgIGNvbnN0IGFsbEZpbGVOYW1lcyA9IGF3YWl0IGZzLnJlYWRkaXIodG1wUm9vdCk7XG4gICAgICBmb3IgKGNvbnN0IGZpbGVOYW1lIG9mIGFsbEZpbGVOYW1lcykge1xuICAgICAgICBjb25zdCBmdWxsUGF0aCA9IHBhdGguam9pbih0bXBSb290LCBmaWxlTmFtZSk7XG4gICAgICAgIGlmIChmaWxlTmFtZSA9PT0gVU5JVkVSU0FMX0FQSykge1xuICAgICAgICAgIHVuaXZlcnNhbEFwa1BhdGggPSBmdWxsUGF0aDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmaWxlRGVsZXRpb25Qcm9taXNlcy5wdXNoKGZzLnJpbXJhZihmdWxsUGF0aCkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBCLmFsbChmaWxlRGVsZXRpb25Qcm9taXNlcyk7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICBpZiAoIXVuaXZlcnNhbEFwa1BhdGgpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBUaGUgZm9sbG93aW5nIGl0ZW1zIHdlcmUgZXh0cmFjdGVkIGZyb20gdGhlIC5hYWIgYnVuZGxlOiAke2FsbEZpbGVOYW1lc31gKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke1VOSVZFUlNBTF9BUEt9IGNhbm5vdCBiZSBmb3VuZCBpbiAnJHthYWJQYXRofScgYnVuZGxlLiBgICtcbiAgICAgICAgICBgRG9lcyB0aGUgYXJjaGl2ZSBjb250YWluIGEgdmFsaWQgYXBwbGljYXRpb24gYnVuZGxlP2ApO1xuICAgICAgfVxuICAgICAgY29uc3QgcmVzdWx0UGF0aCA9IHBhdGguam9pbih0bXBSb290LCBhcGtOYW1lKTtcbiAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgJHtVTklWRVJTQUxfQVBLfSBhdCAnJHt1bml2ZXJzYWxBcGtQYXRofScuIENhY2hpbmcgaXQgdG8gJyR7cmVzdWx0UGF0aH0nYCk7XG4gICAgICBhd2FpdCBmcy5tdih1bml2ZXJzYWxBcGtQYXRoLCByZXN1bHRQYXRoKTtcbiAgICAgIEFBQl9DQUNIRS5zZXQoY2FjaGVIYXNoLCB0bXBSb290KTtcbiAgICAgIHJldHVybiByZXN1bHRQYXRoO1xuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgYXdhaXQgZnMucmltcmFmKHRtcFJvb3QpO1xuICAgIHRocm93IGU7XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFhYlV0aWxzTWV0aG9kcztcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUEsTUFBTUEsU0FBUyxHQUFHLElBQUlDLGlCQUFHLENBQUM7RUFDeEJDLEdBQUcsRUFBRSxFQUFFO0VBQ1BDLE9BQU8sRUFBRSxDQUFDQyxJQUFJLEVBQUVDLGtCQUFrQixLQUFLQyxXQUFFLENBQUNDLE1BQU0sQ0FBQ0Ysa0JBQWtCO0FBQ3JFLENBQUMsQ0FBQztBQUNGLE1BQU1HLGVBQWUsR0FBRyxJQUFJQyxrQkFBUyxFQUFFO0FBQ3ZDLE1BQU1DLGFBQWEsR0FBRyxlQUFlO0FBRXJDLE1BQU1DLGVBQWUsR0FBRyxDQUFDLENBQUM7QUFFMUJDLE9BQU8sQ0FBQ0MsRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNO0VBQ3ZCLElBQUksQ0FBQ2IsU0FBUyxDQUFDYyxJQUFJLEVBQUU7SUFDbkI7RUFDRjtFQUVBLE1BQU1DLEtBQUssR0FBRyxDQUFDLEdBQUdmLFNBQVMsQ0FBQ2dCLE1BQU0sRUFBRSxDQUFDO0VBQ3JDQyxlQUFHLENBQUNDLEtBQUssQ0FBRSx5QkFBd0JILEtBQUssQ0FBQ0ksTUFBTyxlQUFjLEdBQzVEQyxhQUFJLENBQUNDLFNBQVMsQ0FBQyxTQUFTLEVBQUVOLEtBQUssQ0FBQ0ksTUFBTSxDQUFDLENBQUM7RUFDMUMsS0FBSyxNQUFNRyxPQUFPLElBQUlQLEtBQUssRUFBRTtJQUMzQixJQUFJO01BRUZULFdBQUUsQ0FBQ2lCLFVBQVUsQ0FBQ0QsT0FBTyxDQUFDO0lBQ3hCLENBQUMsQ0FBQyxPQUFPRSxDQUFDLEVBQUU7TUFDVlAsZUFBRyxDQUFDUSxJQUFJLENBQUNELENBQUMsQ0FBQ0UsT0FBTyxDQUFDO0lBQ3JCO0VBQ0Y7QUFDRixDQUFDLENBQUM7QUErQkZmLGVBQWUsQ0FBQ2dCLG1CQUFtQixHQUFHLGVBQWVBLG1CQUFtQixDQUFFQyxPQUFPLEVBQUVDLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRTtFQUM1RixJQUFJLEVBQUMsTUFBTXZCLFdBQUUsQ0FBQ3dCLE1BQU0sQ0FBQ0YsT0FBTyxDQUFDLEdBQUU7SUFDN0IsTUFBTSxJQUFJRyxLQUFLLENBQUUsZ0JBQWVILE9BQVEsOENBQTZDLENBQUM7RUFDeEY7RUFFQSxNQUFNSSxPQUFPLEdBQUdDLGFBQUksQ0FBQ0MsUUFBUSxDQUFDTixPQUFPLENBQUM7RUFDdEMsTUFBTU8sT0FBTyxHQUFHSCxPQUFPLENBQUNJLFNBQVMsQ0FBQyxDQUFDLEVBQUVKLE9BQU8sQ0FBQ2IsTUFBTSxHQUFHYyxhQUFJLENBQUNJLE9BQU8sQ0FBQ0wsT0FBTyxDQUFDLENBQUNiLE1BQU0sQ0FBQyxHQUFHLE1BQU07RUFDNUYsTUFBTW1CLE9BQU8sR0FBRyxNQUFNQyxnQkFBTyxDQUFDQyxPQUFPLEVBQUU7RUFDdkMsTUFBTUMsV0FBVyxHQUFHUixhQUFJLENBQUNTLElBQUksQ0FBQ0osT0FBTyxFQUFHLEdBQUVOLE9BQVEsT0FBTSxDQUFDO0VBQ3pELElBQUk7SUFDRixPQUFPLE1BQU14QixlQUFlLENBQUNtQyxPQUFPLENBQUNmLE9BQU8sRUFBRSxZQUFZO01BQ3hELE1BQU1nQixPQUFPLEdBQUcsTUFBTXRDLFdBQUUsQ0FBQ0YsSUFBSSxDQUFDd0IsT0FBTyxDQUFDO01BQ3RDLE1BQU07UUFDSmlCLFFBQVE7UUFDUkMsZ0JBQWdCO1FBQ2hCQyxRQUFRO1FBQ1JDO01BQ0YsQ0FBQyxHQUFHbkIsSUFBSTtNQUNSLElBQUlvQixTQUFTLEdBQUdMLE9BQU87TUFDdkIsSUFBSUMsUUFBUSxFQUFFO1FBQ1osSUFBSSxFQUFDLE1BQU12QyxXQUFFLENBQUN3QixNQUFNLENBQUNlLFFBQVEsQ0FBQyxHQUFFO1VBQzlCLE1BQU0sSUFBSWQsS0FBSyxDQUFFLHlCQUF3QmMsUUFBUywwQkFBeUIsR0FDeEUsc0JBQXFCLENBQUM7UUFDM0I7UUFDQSxJQUFJLENBQUNDLGdCQUFnQixJQUFJLENBQUNDLFFBQVEsSUFBSSxDQUFDQyxXQUFXLEVBQUU7VUFDbEQsTUFBTSxJQUFJakIsS0FBSyxDQUFDLGdFQUFnRSxHQUM5RSw4Q0FBOEMsQ0FBQztRQUNuRDtRQUNBLE1BQU1tQixZQUFZLEdBQUcsTUFBTTVDLFdBQUUsQ0FBQ0YsSUFBSSxDQUFDeUMsUUFBUSxDQUFDO1FBQzVDLE1BQU1NLFlBQVksR0FBR0MsZUFBTSxDQUFDQyxVQUFVLENBQUMsTUFBTSxDQUFDO1FBQzlDRixZQUFZLENBQUNHLE1BQU0sQ0FBQ1AsUUFBUSxDQUFDO1FBQzdCRSxTQUFTLEdBQUcsQ0FBQ0EsU0FBUyxFQUFFQyxZQUFZLEVBQUVDLFlBQVksQ0FBQ0ksTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUNiLElBQUksQ0FBQyxHQUFHLENBQUM7TUFDN0U7TUFDQXpCLGVBQUcsQ0FBQ0MsS0FBSyxDQUFFLGlDQUFnQ1UsT0FBUSxNQUFLcUIsU0FBVSxFQUFDLENBQUM7TUFDcEUsSUFBSWpELFNBQVMsQ0FBQ3dELEdBQUcsQ0FBQ1AsU0FBUyxDQUFDLEVBQUU7UUFDNUIsTUFBTVEsVUFBVSxHQUFHeEIsYUFBSSxDQUFDeUIsT0FBTyxDQUFDMUQsU0FBUyxDQUFDMkQsR0FBRyxDQUFDVixTQUFTLENBQUMsRUFBRWQsT0FBTyxDQUFDO1FBQ2xFLElBQUksTUFBTTdCLFdBQUUsQ0FBQ3dCLE1BQU0sQ0FBQzJCLFVBQVUsQ0FBQyxFQUFFO1VBQy9CLE9BQU9BLFVBQVU7UUFDbkI7UUFDQXpELFNBQVMsQ0FBQzRELEdBQUcsQ0FBQ1gsU0FBUyxDQUFDO01BQzFCO01BRUEsTUFBTSxJQUFJLENBQUNZLFNBQVMsRUFBRTtNQUN0QixNQUFNQyxJQUFJLEdBQUcsQ0FDWCxZQUFZLEVBQ1osU0FBUyxFQUFFLElBQUksQ0FBQ0MsUUFBUSxDQUFDQyxLQUFLLEVBQzlCLFVBQVUsRUFBRXBDLE9BQU8sRUFDbkIsVUFBVSxFQUFFYSxXQUFXLEVBQ3ZCLElBQUlJLFFBQVEsR0FBRyxDQUNiLE1BQU0sRUFBRUEsUUFBUSxFQUNoQixXQUFXLEVBQUcsUUFBT0MsZ0JBQWlCLEVBQUMsRUFDdkMsZ0JBQWdCLEVBQUVDLFFBQVEsRUFDMUIsWUFBWSxFQUFHLFFBQU9DLFdBQVksRUFBQyxDQUNwQyxHQUFHLEVBQUUsQ0FBQyxFQUNQLGtCQUFrQixDQUNuQjtNQUNEL0IsZUFBRyxDQUFDQyxLQUFLLENBQUUsMENBQXlDVSxPQUFRLEdBQUUsQ0FBQztNQUMvRCxNQUFNLElBQUksQ0FBQ3FDLGNBQWMsQ0FBQ0gsSUFBSSxFQUFHLCtDQUE4Q2xDLE9BQVEsR0FBRSxDQUFDO01BRTFGWCxlQUFHLENBQUNDLEtBQUssQ0FBRSw4Q0FBNkN1QixXQUFZLFNBQVFILE9BQVEsR0FBRSxDQUFDO01BQ3ZGLE1BQU0sSUFBQTRCLGtCQUFTLEVBQUN6QixXQUFXLEVBQUVILE9BQU8sQ0FBQztNQUNyQyxJQUFJNkIsZ0JBQWdCO01BQ3BCLE1BQU1DLG9CQUFvQixHQUFHLEVBQUU7TUFDL0IsTUFBTUMsWUFBWSxHQUFHLE1BQU0vRCxXQUFFLENBQUNnRSxPQUFPLENBQUNoQyxPQUFPLENBQUM7TUFDOUMsS0FBSyxNQUFNaUMsUUFBUSxJQUFJRixZQUFZLEVBQUU7UUFDbkMsTUFBTUcsUUFBUSxHQUFHdkMsYUFBSSxDQUFDUyxJQUFJLENBQUNKLE9BQU8sRUFBRWlDLFFBQVEsQ0FBQztRQUM3QyxJQUFJQSxRQUFRLEtBQUs3RCxhQUFhLEVBQUU7VUFDOUJ5RCxnQkFBZ0IsR0FBR0ssUUFBUTtRQUM3QixDQUFDLE1BQU07VUFDTEosb0JBQW9CLENBQUNLLElBQUksQ0FBQ25FLFdBQUUsQ0FBQ0MsTUFBTSxDQUFDaUUsUUFBUSxDQUFDLENBQUM7UUFDaEQ7TUFDRjtNQUNBLElBQUk7UUFDRixNQUFNRSxpQkFBQyxDQUFDQyxHQUFHLENBQUNQLG9CQUFvQixDQUFDO01BQ25DLENBQUMsQ0FBQyxPQUFPUSxHQUFHLEVBQUUsQ0FBQztNQUNmLElBQUksQ0FBQ1QsZ0JBQWdCLEVBQUU7UUFDckJsRCxlQUFHLENBQUNDLEtBQUssQ0FBRSw0REFBMkRtRCxZQUFhLEVBQUMsQ0FBQztRQUNyRixNQUFNLElBQUl0QyxLQUFLLENBQUUsR0FBRXJCLGFBQWMsd0JBQXVCa0IsT0FBUSxZQUFXLEdBQ3hFLHNEQUFxRCxDQUFDO01BQzNEO01BQ0EsTUFBTTZCLFVBQVUsR0FBR3hCLGFBQUksQ0FBQ1MsSUFBSSxDQUFDSixPQUFPLEVBQUVILE9BQU8sQ0FBQztNQUM5Q2xCLGVBQUcsQ0FBQ0MsS0FBSyxDQUFFLFNBQVFSLGFBQWMsUUFBT3lELGdCQUFpQixxQkFBb0JWLFVBQVcsR0FBRSxDQUFDO01BQzNGLE1BQU1uRCxXQUFFLENBQUN1RSxFQUFFLENBQUNWLGdCQUFnQixFQUFFVixVQUFVLENBQUM7TUFDekN6RCxTQUFTLENBQUM4RSxHQUFHLENBQUM3QixTQUFTLEVBQUVYLE9BQU8sQ0FBQztNQUNqQyxPQUFPbUIsVUFBVTtJQUNuQixDQUFDLENBQUM7RUFDSixDQUFDLENBQUMsT0FBT2pDLENBQUMsRUFBRTtJQUNWLE1BQU1sQixXQUFFLENBQUNDLE1BQU0sQ0FBQytCLE9BQU8sQ0FBQztJQUN4QixNQUFNZCxDQUFDO0VBQ1Q7QUFDRixDQUFDO0FBQUMsZUFFYWIsZUFBZTtBQUFBIn0=