{"version":3,"file":"helpers.js","names":["APKS_EXTENSION","APK_EXTENSION","APK_INSTALL_TIMEOUT","APKS_INSTALL_TIMEOUT","DEFAULT_ADB_EXEC_TIMEOUT","MAIN_ACTION","LAUNCHER_CATEGORY","MODULE_NAME","getModuleRoot","_","memoize","root","node","getModuleRootSync","__filename","Error","getSdkRootFromEnv","process","env","ANDROID_HOME","ANDROID_SDK_ROOT","requireSdkRoot","customRoot","sdkRoot","docMsg","isEmpty","fs","exists","stats","stat","isDirectory","getAndroidPlatformAndPath","propsPaths","glob","cwd","path","resolve","absolute","platformsMapping","propsPath","propsContent","readFile","platformPath","dirname","platform","basename","match","exec","log","warn","parseInt","recentSdkVersion","keys","sort","reverse","result","debug","JSON","stringify","unzipFile","zipPath","dstRoot","zip","assertValidZip","extractAllTo","unsignApk","apkPath","tmpRoot","tempDir","openDir","metaInfFolderName","hasMetaInf","readEntries","entry","fileName","startsWith","tmpZipRoot","rimraf","tmpResultPath","toArchive","unlink","mv","getIMEListFromOutput","stdout","engines","line","split","length","push","trim","replace","getJavaHome","JAVA_HOME","getJavaForOs","javaHome","errMsg","err","message","executableName","system","isWindows","resultPath","which","ign","getOpenSslForOs","binaryName","getApksignerForOs","sysHelpers","getBinaryFromSdkRoot","getApkanalyzerForOs","isShowingLockscreen","dumpsys","some","x","includes","every","test","isCurrentFocusOnKeyguard","m","getSurfaceOrientation","isScreenOnFully","buildStartCmd","startAppOptions","apiLevel","user","waitForLaunch","pkg","activity","action","category","stopApp","flags","cmd","util","hasValue","optionalIntentArguments","parseKeyValue","str","space","indexOf","substring","re","args","apply","flag","flagPos","prevArgs","getSdkToolsVersion","androidHome","propertiesPath","propertiesContent","versionMatcher","RegExp","major","minor","build","getBuildToolsDirs","buildToolsDirs","map","dir","a","b","semver","rcompare","pair","pairs","B","mtime","valueOf","info","extractMatchingPermissions","dumpsysOutput","groupNames","grantedState","groupPatternByName","groupName","escapeRegExp","indentPattern","permissionNamePattern","grantedStatePattern","groupMatch","lines","titleIndent","search","slice","currentIndent","permissionNameMatch","item","permission","grantedStateMatch","granted","filteredResult","filter","isBoolean","pluralize","buildInstallArgs","options","allowTestPackages","useSdcard","grantPermissions","partialInstall","parseManifest","manifest","package","versionCode","versionName","application","activities","activityAliases","enabled","intentFilters","actions","categories","isMainAction","name","isLauncherCategory","parseAaptStrings","rawOutput","configMarker","normalizeStringMatch","s","apkStrings","isInConfig","currentResourceId","isInPluralGroup","quotedStringPattern","os","EOL","trimmedLine","parseAapt2Strings","allLines","extractContent","startIdx","idx","startCharPos","terminationCharMatch","terminationCharPos","index","trimStart","isInCurrentConfig","lineIndex","content","isString","formatConfigMarker","configsGetter","desiredMarker","defaultMarker","configs","toLowerCase","parseJsonData","output","entityName","jsonStr","parse","e","toAvdLocaleArgs","language","country","toUpperCase","locale","getAndroidPrefsRoot","location","ANDROID_EMULATOR_HOME","dirExists","home","HOME","USERPROFILE","escapeShellArg","arg","parseLaunchableActivityNames","mainActivityNameRe","categoryNameRe","blocks","blockStartIndent","block","trimEnd","isNil","hasCategory","activityNameStr","Boolean","fqActivityName","matchComponentName","classString"],"sources":["../../lib/helpers.js"],"sourcesContent":["import path from 'path';\nimport { system, fs, zip, util, tempDir, node } from '@appium/support';\nimport log from './logger.js';\nimport _ from 'lodash';\nimport B from 'bluebird';\nimport semver from 'semver';\nimport os from 'os';\n\nconst APKS_EXTENSION = '.apks';\nconst APK_EXTENSION = '.apk';\nconst APK_INSTALL_TIMEOUT = 60000;\nconst APKS_INSTALL_TIMEOUT = APK_INSTALL_TIMEOUT * 2;\nconst DEFAULT_ADB_EXEC_TIMEOUT = 20000; // in milliseconds\nconst MAIN_ACTION = 'android.intent.action.MAIN';\nconst LAUNCHER_CATEGORY = 'android.intent.category.LAUNCHER';\nconst MODULE_NAME = 'appium-adb';\n\n/**\n * Calculates the path to the current module's root folder\n *\n * @returns {string} The full path to module root\n * @throws {Error} If the current module root folder cannot be determined\n */\nconst getModuleRoot = _.memoize(function getModuleRoot () {\n  const root = node.getModuleRootSync(MODULE_NAME, __filename);\n  if (!root) {\n    throw new Error(`Cannot find the root folder of the ${MODULE_NAME} Node.js module`);\n  }\n  return root;\n});\n\n/**\n * Retrieves the actual path to SDK root folder from the system environment\n *\n * @return {?string} The full path to the SDK root folder\n */\nfunction getSdkRootFromEnv () {\n  return process.env.ANDROID_HOME || process.env.ANDROID_SDK_ROOT;\n}\n\n/**\n * Retrieves the actual path to SDK root folder\n *\n * @return {string} The full path to the SDK root folder\n * @throws {Error} If either the corresponding env variable is unset or is\n * pointing to an invalid file system entry\n */\nasync function requireSdkRoot (customRoot = null) {\n  const sdkRoot = customRoot || getSdkRootFromEnv();\n  const docMsg = 'Read https://developer.android.com/studio/command-line/variables for more details';\n  if (_.isEmpty(sdkRoot)) {\n    throw new Error(`Neither ANDROID_HOME nor ANDROID_SDK_ROOT environment variable was exported. ${docMsg}`);\n  }\n\n  if (!await fs.exists(sdkRoot)) {\n    throw new Error(`The Android SDK root folder '${sdkRoot}' does not exist on the local file system. ${docMsg}`);\n  }\n  const stats = await fs.stat(sdkRoot);\n  if (!stats.isDirectory()) {\n    throw new Error(`The Android SDK root '${sdkRoot}' must be a folder. ${docMsg}`);\n  }\n  return sdkRoot;\n}\n\n/**\n * @typedef {Object} PlatformInfo\n * @property {?string} platform - The platform name, for example `android-24`\n *                                or `null` if it cannot be found\n * @property {?string} platformPath - Full path to the platform SDK folder\n *                                    or `null` if it cannot be found\n */\n\n/**\n * Retrieve the path to the recent installed Android platform.\n *\n * @return {PlatformInfo} The resulting path to the newest installed platform.\n */\nasync function getAndroidPlatformAndPath (sdkRoot) {\n  const propsPaths = await fs.glob('*/build.prop', {\n    cwd: path.resolve(sdkRoot, 'platforms'),\n    absolute: true,\n  });\n  const platformsMapping = {};\n  for (const propsPath of propsPaths) {\n    const propsContent = await fs.readFile(propsPath, 'utf-8');\n    const platformPath = path.dirname(propsPath);\n    const platform = path.basename(platformPath);\n    const match = /ro\\.build\\.version\\.sdk=(\\d+)/.exec(propsContent);\n    if (!match) {\n      log.warn(`Cannot read the SDK version from '${propsPath}'. Skipping '${platform}'`);\n      continue;\n    }\n    platformsMapping[parseInt(match[1], 10)] = {\n      platform,\n      platformPath,\n    };\n  }\n  if (_.isEmpty(platformsMapping)) {\n    log.warn(`Found zero platform folders at '${path.resolve(sdkRoot, 'platforms')}'. ` +\n      `Do you have any Android SDKs installed?`);\n    return {\n      platform: null,\n      platformPath: null,\n    };\n  }\n\n  const recentSdkVersion = _.keys(platformsMapping).sort().reverse()[0];\n  const result = platformsMapping[recentSdkVersion];\n  log.debug(`Found the most recent Android platform: ${JSON.stringify(result)}`);\n  return result;\n}\n\nasync function unzipFile (zipPath, dstRoot = path.dirname(zipPath)) {\n  log.debug(`Unzipping '${zipPath}' to '${dstRoot}'`);\n  await zip.assertValidZip(zipPath);\n  await zip.extractAllTo(zipPath, dstRoot);\n  log.debug('Unzip successful');\n}\n\n/**\n * Unsigns the given apk by removing the\n * META-INF folder recursively from the archive.\n * !!! The function overwrites the given apk after successful unsigning !!!\n *\n * @param {string} apkPath The path to the apk\n * @returns {boolean} `true` if the apk has been successfully\n * unsigned and overwritten\n * @throws {Error} if there was an error during the unsign operation\n */\nasync function unsignApk (apkPath) {\n  const tmpRoot = await tempDir.openDir();\n  const metaInfFolderName = 'META-INF';\n  try {\n    let hasMetaInf = false;\n    await zip.readEntries(apkPath, ({entry}) => {\n      hasMetaInf = entry.fileName.startsWith(`${metaInfFolderName}/`);\n      // entries iteration stops after `false` is returned\n      return !hasMetaInf;\n    });\n    if (!hasMetaInf) {\n      return false;\n    }\n    const tmpZipRoot = path.resolve(tmpRoot, 'apk');\n    await zip.extractAllTo(apkPath, tmpZipRoot);\n    await fs.rimraf(path.resolve(tmpZipRoot, metaInfFolderName));\n    const tmpResultPath = path.resolve(tmpRoot, path.basename(apkPath));\n    await zip.toArchive(tmpResultPath, {\n      cwd: tmpZipRoot,\n    });\n    await fs.unlink(apkPath);\n    await fs.mv(tmpResultPath, apkPath);\n    return true;\n  } finally {\n    await fs.rimraf(tmpRoot);\n  }\n}\n\nfunction getIMEListFromOutput (stdout) {\n  let engines = [];\n  for (let line of stdout.split('\\n')) {\n    if (line.length > 0 && line[0] !== ' ') {\n      // remove newline and trailing colon, and add to the list\n      engines.push(line.trim().replace(/:$/, ''));\n    }\n  }\n  return engines;\n}\n\nconst getJavaHome = _.memoize(async function getJavaHome () {\n  const result = process.env.JAVA_HOME;\n  if (!result) {\n    throw new Error('The JAVA_HOME environment variable is not set for the current process');\n  }\n  if (!await fs.exists(result)) {\n    throw new Error(`The JAVA_HOME location '${result}' must exist`);\n  }\n  const stats = await fs.stat(result);\n  if (!stats.isDirectory()) {\n    throw new Error(`The JAVA_HOME location '${result}' must be a valid folder`);\n  }\n  return result;\n});\n\nconst getJavaForOs = _.memoize(async function getJavaForOs () {\n  let javaHome;\n  let errMsg;\n  try {\n    javaHome = await getJavaHome();\n  } catch (err) {\n    errMsg = err.message;\n  }\n  const executableName = `java${system.isWindows() ? '.exe' : ''}`;\n  if (javaHome) {\n    const resultPath = path.resolve(javaHome, 'bin', executableName);\n    if (await fs.exists(resultPath)) {\n      return resultPath;\n    }\n  }\n  try {\n    return await fs.which(executableName);\n  } catch (ign) {}\n  throw new Error(`The '${executableName}' binary could not be found ` +\n    `neither in PATH nor under JAVA_HOME (${errMsg || path.resolve(javaHome, 'bin')})`);\n});\n\nconst getOpenSslForOs = async function () {\n  const binaryName = `openssl${system.isWindows() ? '.exe' : ''}`;\n  try {\n    return await fs.which(binaryName);\n  } catch (err) {\n    throw new Error('The openssl tool must be installed on the system and available on the path');\n  }\n};\n\n/**\n * Get the absolute path to apksigner tool\n *\n * @param {Object} sysHelpers - An instance containing systemCallMethods helper methods\n * @returns {string} An absolute path to apksigner tool.\n * @throws {Error} If the tool is not present on the local file system.\n */\nasync function getApksignerForOs (sysHelpers) {\n  return await sysHelpers.getBinaryFromSdkRoot('apksigner.jar');\n}\n\n/**\n * Get the absolute path to apkanalyzer tool.\n * https://developer.android.com/studio/command-line/apkanalyzer.html\n *\n * @param {Object} sysHelpers - An instance containing systemCallMethods helper methods\n * @returns {string} An absolute path to apkanalyzer tool.\n * @throws {Error} If the tool is not present on the local file system.\n */\nasync function getApkanalyzerForOs (sysHelpers) {\n  return await sysHelpers.getBinaryFromSdkRoot('apkanalyzer');\n}\n\n/**\n * Checks mShowingLockscreen or mDreamingLockscreen in dumpsys output to determine\n * if lock screen is showing\n *\n * A note: `adb shell dumpsys trust` performs better while detecting the locked screen state\n * in comparison to `adb dumpsys window` output parsing.\n * But the trust command does not work for `Swipe` unlock pattern.\n *\n * In some Android devices (Probably around Android 10+), `mShowingLockscreen` and `mDreamingLockscreen`\n * do not work to detect lock status. Instead, keyguard preferences helps to detect the lock condition.\n * Some devices such as Android TV do not have keyguard, so we should keep\n * screen condition as this primary method.\n *\n * @param {string} dumpsys - The output of dumpsys window command.\n * @return {boolean} True if lock screen is showing.\n */\nfunction isShowingLockscreen (dumpsys) {\n  return _.some(['mShowingLockscreen=true', 'mDreamingLockscreen=true'], (x) => dumpsys.includes(x))\n    // `mIsShowing` and `mInputRestricted` are `true` in lock condition. `false` is unlock condition.\n    || _.every([/KeyguardStateMonitor[\\n\\s]+mIsShowing=true/, /\\s+mInputRestricted=true/], (x) => x.test(dumpsys));\n}\n\n/*\n * Checks mCurrentFocus in dumpsys output to determine if Keyguard is activated\n */\nfunction isCurrentFocusOnKeyguard (dumpsys) {\n  let m = /mCurrentFocus.+Keyguard/gi.exec(dumpsys);\n  return (m && m.length && m[0]) ? true : false;\n}\n\n/*\n * Reads SurfaceOrientation in dumpsys output\n */\nfunction getSurfaceOrientation (dumpsys) {\n  let m = /SurfaceOrientation: \\d/gi.exec(dumpsys);\n  return m && parseInt(m[0].split(':')[1], 10);\n}\n\n/*\n * Checks mScreenOnFully in dumpsys output to determine if screen is showing\n * Default is true\n */\nfunction isScreenOnFully (dumpsys) {\n  let m = /mScreenOnFully=\\w+/gi.exec(dumpsys);\n  return !m || // if information is missing we assume screen is fully on\n         (m && m.length > 0 && m[0].split('=')[1] === 'true') || false;\n}\n\n/**\n * Builds command line representation for the given\n * application startup options\n *\n * @param {StartAppOptions} startAppOptions - Application options mapping\n * @param {number} apiLevel - The actual OS API level\n * @returns {Array<String>} The actual command line array\n */\nfunction buildStartCmd (startAppOptions, apiLevel) {\n  const {\n    user,\n    waitForLaunch,\n    pkg,\n    activity,\n    action,\n    category,\n    stopApp,\n    flags,\n  } = startAppOptions;\n  const cmd = ['am', 'start'];\n  if (util.hasValue(user)) {\n    cmd.push('--user', user);\n  }\n  if (waitForLaunch) {\n    cmd.push('-W');\n  }\n  if (activity && pkg) {\n    cmd.push('-n', `${pkg}/${activity}`);\n  }\n  if (stopApp && apiLevel >= 15) {\n    cmd.push('-S');\n  }\n  if (action) {\n    cmd.push('-a', action);\n  }\n  if (category) {\n    cmd.push('-c', category);\n  }\n  if (flags) {\n    cmd.push('-f', flags);\n  }\n  if (startAppOptions.optionalIntentArguments) {\n    // expect optionalIntentArguments to be a single string of the form:\n    //     \"-flag key\"\n    //     \"-flag key value\"\n    // or a combination of these (e.g., \"-flag1 key1 -flag2 key2 value2\")\n\n    // take a string and parse out the part before any spaces, and anything after\n    // the first space\n    let parseKeyValue = function (str) {\n      str = str.trim();\n      let space = str.indexOf(' ');\n      if (space === -1) {\n        return str.length ? [str] : [];\n      } else {\n        return [str.substring(0, space).trim(), str.substring(space + 1).trim()];\n      }\n    };\n\n    // cycle through the optionalIntentArguments and pull out the arguments\n    // add a space initially so flags can be distinguished from arguments that\n    // have internal hyphens\n    let optionalIntentArguments = ` ${startAppOptions.optionalIntentArguments}`;\n    let re = / (-[^\\s]+) (.+)/;\n    while (true) { // eslint-disable-line no-constant-condition\n      let args = re.exec(optionalIntentArguments);\n      if (!args) {\n        if (optionalIntentArguments.length) {\n          // no more flags, so the remainder can be treated as 'key' or 'key value'\n          cmd.push.apply(cmd, parseKeyValue(optionalIntentArguments));\n        }\n        // we are done\n        break;\n      }\n\n      // take the flag and see if it is at the beginning of the string\n      // if it is not, then it means we have been through already, and\n      // what is before the flag is the argument for the previous flag\n      let flag = args[1];\n      let flagPos = optionalIntentArguments.indexOf(flag);\n      if (flagPos !== 0) {\n        let prevArgs = optionalIntentArguments.substring(0, flagPos);\n        cmd.push.apply(cmd, parseKeyValue(prevArgs));\n      }\n\n      // add the flag, as there are no more earlier arguments\n      cmd.push(flag);\n\n      // make optionalIntentArguments hold the remainder\n      optionalIntentArguments = args[2];\n    }\n  }\n  return cmd;\n}\n\nconst getSdkToolsVersion = _.memoize(async function getSdkToolsVersion () {\n  const androidHome = process.env.ANDROID_HOME;\n  if (!androidHome) {\n    throw new Error('ANDROID_HOME environment variable is expected to be set');\n  }\n  const propertiesPath = path.resolve(androidHome, 'tools', 'source.properties');\n  if (!await fs.exists(propertiesPath)) {\n    log.warn(`Cannot find ${propertiesPath} file to read SDK version from`);\n    return;\n  }\n  const propertiesContent = await fs.readFile(propertiesPath, 'utf8');\n  const versionMatcher = new RegExp(/Pkg\\.Revision=(\\d+)\\.?(\\d+)?\\.?(\\d+)?/);\n  const match = versionMatcher.exec(propertiesContent);\n  if (match) {\n    return {\n      major: parseInt(match[1], 10),\n      minor: match[2] ? parseInt(match[2], 10) : 0,\n      build: match[3] ? parseInt(match[3], 10) : 0\n    };\n  }\n  log.warn(`Cannot parse \"Pkg.Revision\" value from ${propertiesPath}`);\n});\n\n/**\n * Retrieves full paths to all 'build-tools' subfolders under the particular\n * SDK root folder\n *\n * @param {string} sdkRoot - The full path to the Android SDK root folder\n * @returns {Array<string>} The full paths to the resulting folders sorted by\n * modification date (the newest comes first) or an empty list if no macthes were found\n */\nconst getBuildToolsDirs = _.memoize(async function getBuildToolsDirs (sdkRoot) {\n  let buildToolsDirs = await fs.glob('*/', {\n    cwd: path.resolve(sdkRoot, 'build-tools'),\n    absolute: true,\n  });\n  try {\n    buildToolsDirs = buildToolsDirs\n      .map((dir) => [path.basename(dir), dir])\n      .sort((a, b) => semver.rcompare(a[0], b[0]))\n      .map((pair) => pair[1]);\n  } catch (err) {\n    log.warn(`Cannot sort build-tools folders ${JSON.stringify(buildToolsDirs.map((dir) => path.basename(dir)))} ` +\n      `by semantic version names.`);\n    log.warn(`Falling back to sorting by modification date. Original error: ${err.message}`);\n    const pairs = await B.map(buildToolsDirs, async (dir) => [(await fs.stat(dir)).mtime.valueOf(), dir]);\n    buildToolsDirs = pairs\n      .sort((a, b) => a[0] < b[0])\n      .map((pair) => pair[1]);\n  }\n  log.info(`Found ${buildToolsDirs.length} 'build-tools' folders under '${sdkRoot}' (newest first):`);\n  for (let dir of buildToolsDirs) {\n    log.info(`    ${dir}`);\n  }\n  return buildToolsDirs;\n});\n\n/**\n * Retrieves the list of permission names encoded in `dumpsys package` command output.\n *\n * @param {string} dumpsysOutput - The actual command output.\n * @param {Array<string>} groupNames - The list of group names to list permissions for.\n * @param {?boolean} grantedState - The expected state of `granted` attribute to filter with.\n *                                  No filtering is done if the parameter is not set.\n * @returns {Array<string>} The list of matched permission names or an empty list if no matches were found.\n */\nconst extractMatchingPermissions = function (dumpsysOutput, groupNames, grantedState = null) {\n  const groupPatternByName = (groupName) => new RegExp(`^(\\\\s*${_.escapeRegExp(groupName)} permissions:[\\\\s\\\\S]+)`, 'm');\n  const indentPattern = /\\S|$/;\n  const permissionNamePattern = /android\\.\\w*\\.?permission\\.\\w+/;\n  const grantedStatePattern = /\\bgranted=(\\w+)/;\n  const result = [];\n  for (const groupName of groupNames) {\n    const groupMatch = groupPatternByName(groupName).exec(dumpsysOutput);\n    if (!groupMatch) {\n      continue;\n    }\n\n    const lines = groupMatch[1].split('\\n');\n    if (lines.length < 2) {\n      continue;\n    }\n\n    const titleIndent = lines[0].search(indentPattern);\n    for (const line of lines.slice(1)) {\n      const currentIndent = line.search(indentPattern);\n      if (currentIndent <= titleIndent) {\n        break;\n      }\n\n      const permissionNameMatch = permissionNamePattern.exec(line);\n      if (!permissionNameMatch) {\n        continue;\n      }\n      const item = {\n        permission: permissionNameMatch[0],\n      };\n      const grantedStateMatch = grantedStatePattern.exec(line);\n      if (grantedStateMatch) {\n        item.granted = grantedStateMatch[1] === 'true';\n      }\n      result.push(item);\n    }\n  }\n\n  const filteredResult = result\n    .filter((item) => !_.isBoolean(grantedState) || item.granted === grantedState)\n    .map((item) => item.permission);\n  log.debug(`Retrieved ${util.pluralize('permission', filteredResult.length, true)} ` +\n    `from ${groupNames} ${util.pluralize('group', groupNames.length, false)}`);\n  return filteredResult;\n};\n\n/**\n * @typedef {Object} InstallOptions\n * @property {boolean} allowTestPackages [false] - Set to true in order to allow test\n *                                                 packages installation.\n * @property {boolean} useSdcard [false] - Set to true to install the app on sdcard\n *                                         instead of the device memory.\n * @property {boolean} grantPermissions [false] - Set to true in order to grant all the\n *                                                permissions requested in the application's manifest\n *                                                automatically after the installation is completed\n *                                                under Android 6+.\n * @property {boolean} replace [true] - Set it to false if you don't want\n *                                      the application to be upgraded/reinstalled\n *                                      if it is already present on the device.\n * @property {boolean} partialInstall [false] - Install apks partially. It is used for 'install-multiple'.\n *                                             https://android.stackexchange.com/questions/111064/what-is-a-partial-application-install-via-adb\n */\n\n/**\n * Transforms given options into the list of `adb install.install-multiple` command arguments\n *\n * @param {number} apiLevel - The current API level\n * @param {?InstallOptions} options - The options mapping to transform\n * @returns {Array<String>} The array of arguments\n */\nfunction buildInstallArgs (apiLevel, options = {}) {\n  const result = [];\n\n  if (!util.hasValue(options.replace) || options.replace) {\n    result.push('-r');\n  }\n  if (options.allowTestPackages) {\n    result.push('-t');\n  }\n  if (options.useSdcard) {\n    result.push('-s');\n  }\n  if (options.grantPermissions) {\n    if (apiLevel < 23) {\n      log.debug(`Skipping permissions grant option, since ` +\n                `the current API level ${apiLevel} does not support applications ` +\n                `permissions customization`);\n    } else {\n      result.push('-g');\n    }\n  }\n  // For multiple-install\n  if (options.partialInstall) {\n    result.push('-p');\n  }\n\n  return result;\n}\n\n/**\n * @typedef {Object} ManifestInfo\n * @property {string} pkg - The application identifier\n * @property {string} activity - The name of the main package activity\n * @property {?number} versionCode - The version code number (might be `NaN`)\n * @property {?string} versionName - The version name (might be `null`)\n */\n\n/**\n * Perform parsing of the manifest object in order\n * to extract some vital values from it\n *\n * @param {object} manifest The manifest content formatted as JSON\n * See https://www.npmjs.com/package/adbkit-apkreader for detailed format description\n * @returns {ManifestInfo}\n */\nfunction parseManifest (manifest) {\n  const result = {\n    pkg: manifest.package,\n    versionCode: parseInt(manifest.versionCode, 10),\n    versionName: manifest.versionName || null,\n  };\n  if (!manifest.application) {\n    return result;\n  }\n\n  // Look for enabled activity or activity-alias with\n  // action == android.intent.action.MAIN and\n  // category == android.intent.category.LAUNCHER\n  for (const activity of [\n    ...manifest.application.activities,\n    ...manifest.application.activityAliases,\n  ]) {\n    if (activity.enabled === false || _.isEmpty(activity.intentFilters)) {\n      continue;\n    }\n\n    for (const {actions, categories} of activity.intentFilters) {\n      if (_.isEmpty(actions) || _.isEmpty(categories)) {\n        continue;\n      }\n\n      const isMainAction = actions.some(({name}) => name === MAIN_ACTION);\n      const isLauncherCategory = categories.some(({name}) => name === LAUNCHER_CATEGORY);\n      if (isMainAction && isLauncherCategory) {\n        result.activity = activity.name;\n        return result;\n      }\n    }\n  }\n  return result;\n}\n\n/**\n * Parses apk strings from aapt tool output\n *\n * @param {string} rawOutput The actual tool output\n * @param {string} configMarker The config marker. Usually\n * a language abbreviation or `(default)`\n * @returns {Object} Strings ids to values mapping. Plural\n * values are represented as arrays. If no config found for the\n * given marker then an empty mapping is returned.\n */\nfunction parseAaptStrings (rawOutput, configMarker) {\n  const normalizeStringMatch = function (s) {\n    return s.replace(/\"$/, '').replace(/^\"/, '').replace(/\\\\\"/g, '\"');\n  };\n\n  const apkStrings = {};\n  let isInConfig = false;\n  let currentResourceId = null;\n  let isInPluralGroup = false;\n  // The pattern matches any quoted content including escaped quotes\n  const quotedStringPattern = /\"[^\"\\\\]*(?:\\\\.[^\"\\\\]*)*\"/;\n  for (const line of rawOutput.split(os.EOL)) {\n    const trimmedLine = line.trim();\n    if (_.isEmpty(trimmedLine)) {\n      continue;\n    }\n\n    if (['config', 'type', 'spec', 'Package'].some((x) => trimmedLine.startsWith(x))) {\n      isInConfig = trimmedLine.startsWith(`config ${configMarker}:`);\n      currentResourceId = null;\n      isInPluralGroup = false;\n      continue;\n    }\n\n    if (!isInConfig) {\n      continue;\n    }\n\n    if (trimmedLine.startsWith('resource')) {\n      isInPluralGroup = false;\n      currentResourceId = null;\n\n      if (trimmedLine.includes(':string/')) {\n        const match = /:string\\/(\\S+):/.exec(trimmedLine);\n        if (match) {\n          currentResourceId = match[1];\n        }\n      } else if (trimmedLine.includes(':plurals/')) {\n        const match = /:plurals\\/(\\S+):/.exec(trimmedLine);\n        if (match) {\n          currentResourceId = match[1];\n          isInPluralGroup = true;\n        }\n      }\n      continue;\n    }\n\n    if (currentResourceId && trimmedLine.startsWith('(string')) {\n      const match = quotedStringPattern.exec(trimmedLine);\n      if (match) {\n        apkStrings[currentResourceId] = normalizeStringMatch(match[0]);\n      }\n      currentResourceId = null;\n      continue;\n    }\n\n    if (currentResourceId && isInPluralGroup && trimmedLine.includes(': (string')) {\n      const match = quotedStringPattern.exec(trimmedLine);\n      if (match) {\n        apkStrings[currentResourceId] = [\n          ...(apkStrings[currentResourceId] || []),\n          normalizeStringMatch(match[0]),\n        ];\n      }\n      continue;\n    }\n  }\n  return apkStrings;\n}\n\n/**\n * Parses apk strings from aapt2 tool output\n *\n * @param {string} rawOutput The actual tool output\n * @param {string} configMarker The config marker. Usually\n * a language abbreviation or an empty string for the default one\n * @returns {Object} Strings ids to values mapping. Plural\n * values are represented as arrays. If no config found for the\n * given marker then an empty mapping is returned.\n */\nfunction parseAapt2Strings (rawOutput, configMarker) {\n  const allLines = rawOutput.split(os.EOL);\n  function extractContent (startIdx) {\n    let idx = startIdx;\n    const startCharPos = allLines[startIdx].indexOf('\"');\n    if (startCharPos < 0) {\n      return [null, idx];\n    }\n    let result = '';\n    while (idx < allLines.length) {\n      const terminationCharMatch = /\"$/.exec(allLines[idx]);\n      if (terminationCharMatch) {\n        const terminationCharPos = terminationCharMatch.index;\n        if (startIdx === idx) {\n          return [\n            allLines[idx].substring(startCharPos + 1, terminationCharPos),\n            idx\n          ];\n        }\n        return [\n          `${result}\\\\n${_.trimStart(allLines[idx].substring(0, terminationCharPos))}`,\n          idx,\n        ];\n      }\n      if (idx > startIdx) {\n        result += `\\\\n${_.trimStart(allLines[idx])}`;\n      } else {\n        result += allLines[idx].substring(startCharPos + 1);\n      }\n      ++idx;\n    }\n    return [result, idx];\n  }\n\n  const apkStrings = {};\n  let currentResourceId = null;\n  let isInPluralGroup = false;\n  let isInCurrentConfig = false;\n  let lineIndex = 0;\n  while (lineIndex < allLines.length) {\n    const trimmedLine = allLines[lineIndex].trim();\n    if (_.isEmpty(trimmedLine)) {\n      ++lineIndex;\n      continue;\n    }\n\n    if (['type', 'Package'].some((x) => trimmedLine.startsWith(x))) {\n      currentResourceId = null;\n      isInPluralGroup = false;\n      isInCurrentConfig = false;\n      ++lineIndex;\n      continue;\n    }\n\n    if (trimmedLine.startsWith('resource')) {\n      isInPluralGroup = false;\n      currentResourceId = null;\n      isInCurrentConfig = false;\n\n      if (trimmedLine.includes('string/')) {\n        const match = /string\\/(\\S+)/.exec(trimmedLine);\n        if (match) {\n          currentResourceId = match[1];\n        }\n      } else if (trimmedLine.includes('plurals/')) {\n        const match = /plurals\\/(\\S+)/.exec(trimmedLine);\n        if (match) {\n          currentResourceId = match[1];\n          isInPluralGroup = true;\n        }\n      }\n      ++lineIndex;\n      continue;\n    }\n\n    if (currentResourceId) {\n      if (isInPluralGroup) {\n        if (trimmedLine.startsWith('(')) {\n          isInCurrentConfig = trimmedLine.startsWith(`(${configMarker})`);\n          ++lineIndex;\n          continue;\n        }\n        if (isInCurrentConfig) {\n          const [content, idx] = extractContent(lineIndex);\n          lineIndex = idx;\n          if (_.isString(content)) {\n            apkStrings[currentResourceId] = [\n              ...(apkStrings[currentResourceId] || []),\n              content,\n            ];\n          }\n        }\n      } else if (trimmedLine.startsWith(`(${configMarker})`)) {\n        const [content, idx] = extractContent(lineIndex);\n        lineIndex = idx;\n        if (_.isString(content)) {\n          apkStrings[currentResourceId] = content;\n        }\n        currentResourceId = null;\n      }\n    }\n    ++lineIndex;\n  }\n  return apkStrings;\n}\n\n/**\n * Formats the config marker, which is then passed to parse.. methods\n * to make it compatible with resource formats generated by aapt(2) tool\n *\n * @param {Function} configsGetter The function whose result is a list\n * of apk configs\n * @param {string} desiredMarker The desired config marker value\n * @param {string} defaultMarker The default config marker value\n * @return {string} The formatted config marker\n */\nasync function formatConfigMarker (configsGetter, desiredMarker, defaultMarker) {\n  let configMarker = desiredMarker || defaultMarker;\n  if (configMarker.includes('-') && !configMarker.includes('-r')) {\n    configMarker = configMarker.replace('-', '-r');\n  }\n  const configs = await configsGetter();\n  log.debug(`Resource configurations: ${JSON.stringify(configs)}`);\n  // Assume the 'en' configuration is the default one\n  if (configMarker.toLowerCase().startsWith('en')\n    && !configs.some((x) => x.trim() === configMarker)) {\n    log.debug(`Resource configuration name '${configMarker}' is unknown. ` +\n      `Replacing it with '${defaultMarker}'`);\n    configMarker = defaultMarker;\n  } else {\n    log.debug(`Selected configuration: '${configMarker}'`);\n  }\n  return configMarker;\n}\n\n/**\n * Parses the output in JSON format retrieved from\n * the corresponding Appium Settings broadcast calls\n *\n * @param {string} output The actual command output\n * @param {string} entityName The name of the entity which is\n * going to be parsed\n * @returns {Object} The parsed JSON object\n * @throws {Error} If the output cannot be parsed\n * as a valid JSON\n */\nfunction parseJsonData (output, entityName) {\n  if (!/\\bresult=-1\\b/.test(output) || !/\\bdata=\"/.test(output)) {\n    log.debug(output);\n    throw new Error(`Cannot retrieve ${entityName} from the device. ` +\n      'Check the server log for more details');\n  }\n  const match = /\\bdata=(\".+)/.exec(output);\n  if (!match) {\n    log.debug(output);\n    throw new Error(`Cannot parse ${entityName} from the command output. ` +\n      'Check the server log for more details');\n  }\n  const jsonStr = _.trim(match[1]).replace(/(^\")|(\"$)/g, '');\n  try {\n    return JSON.parse(jsonStr);\n  } catch (e) {\n    log.debug(jsonStr);\n    throw new Error(`Cannot parse ${entityName} from the resulting data string. ` +\n      'Check the server log for more details');\n  }\n}\n\n/**\n * Transforms the given language and country abbreviations\n * to AVD arguments array\n *\n * @param {?string} language Language name, for example 'fr'\n * @param {?string} country Country name, for example 'CA'\n * @returns {Array<string>} The generated arguments. The\n * resulting array might be empty if both arguments are empty\n */\nfunction toAvdLocaleArgs (language, country) {\n  const result = [];\n  if (language && _.isString(language)) {\n    result.push('-prop', `persist.sys.language=${language.toLowerCase()}`);\n  }\n  if (country && _.isString(country)) {\n    result.push('-prop', `persist.sys.country=${country.toUpperCase()}`);\n  }\n  let locale;\n  if (_.isString(language) && _.isString(country) && language && country) {\n    locale = language.toLowerCase() + '-' + country.toUpperCase();\n  } else if (language && _.isString(language)) {\n    locale = language.toLowerCase();\n  } else if (country && _.isString(country)) {\n    locale = country;\n  }\n  if (locale) {\n    result.push('-prop', `persist.sys.locale=${locale}`);\n  }\n  return result;\n}\n\n/**\n * Retrieves the full path to the Android preferences root\n *\n * @returns {?string} The full path to the folder or `null` if the folder cannot be found\n */\nasync function getAndroidPrefsRoot () {\n  let location = process.env.ANDROID_EMULATOR_HOME;\n  if (await dirExists(location)) {\n    return location;\n  }\n\n  if (location) {\n    log.warn(`The value of the ANDROID_EMULATOR_HOME environment variable '${location}' is not an existing directory`);\n  }\n\n  const home = process.env.HOME || process.env.USERPROFILE;\n  if (home) {\n    location = path.resolve(home, '.android');\n  }\n\n  if (!await dirExists(location)) {\n    log.debug(`Android config root '${location}' is not an existing directory`);\n    return null;\n  }\n\n  return location;\n}\n\n/**\n * Check if a path exists on the filesystem and is a directory\n *\n * @param {?string} location The full path to the directory\n * @returns {boolean}\n */\nasync function dirExists (location) {\n  return location\n    && await fs.exists(location)\n    && (await fs.stat(location)).isDirectory();\n}\n\n/**\n * Escapes special characters in command line arguments.\n * This is needed to avoid possible issues with how system `spawn`\n * call handles them.\n * See https://discuss.appium.io/t/how-to-modify-wd-proxy-and-uiautomator2-source-code-to-support-unicode/33466\n * for more details.\n *\n * @param {string} arg Non-escaped argument string\n * @returns The escaped argument\n */\nfunction escapeShellArg (arg) {\n  arg = `${arg}`;\n  if (system.isWindows()) {\n    return /[&|^\\s]/.test(arg) ? `\"${arg.replace(/\"/g, '\"\"')}\"` : arg;\n  }\n  return arg.replace(/&/g, '\\\\&');\n}\n\n/**\n * Parses the name of launchable package activity\n * from dumpsys output.\n *\n * @param {string} dumpsys the actual dumpsys output\n * @returns {string[]} Either the fully qualified\n * activity name as a single list item or an empty list if nothing could be parsed.\n * In Android 6 and older there is no reliable way to determine\n * the category name for the given activity, so this API just\n * returns all activity names belonging to 'android.intent.action.MAIN'\n * with the expectation that the app manifest could be parsed next\n * in order to determine category names for these.\n */\nfunction parseLaunchableActivityNames (dumpsys) {\n  const mainActivityNameRe = new RegExp(`^\\\\s*${_.escapeRegExp(MAIN_ACTION)}:$`);\n  const categoryNameRe = /^\\s*Category:\\s+\"([a-zA-Z0-9._/-]+)\"$/;\n  const blocks = [];\n  let blockStartIndent;\n  let block = [];\n  for (const line of dumpsys.split('\\n').map(_.trimEnd)) {\n    const currentIndent = line.length - _.trimStart(line).length;\n    if (mainActivityNameRe.test(line)) {\n      blockStartIndent = currentIndent;\n      if (!_.isEmpty(block)) {\n        blocks.push(block);\n        block = [];\n      }\n      continue;\n    }\n    if (_.isNil(blockStartIndent)) {\n      continue;\n    }\n\n    if (currentIndent > blockStartIndent) {\n      block.push(line);\n    } else {\n      if (!_.isEmpty(block)) {\n        blocks.push(block);\n        block = [];\n      }\n      blockStartIndent = null;\n    }\n  }\n  if (!_.isEmpty(block)) {\n    blocks.push(block);\n  }\n\n  const result = [];\n  for (const item of blocks) {\n    let hasCategory = false;\n    let isLauncherCategory = false;\n    for (const line of item) {\n      const match = categoryNameRe.exec(line);\n      if (!match) {\n        continue;\n      }\n\n      hasCategory = true;\n      isLauncherCategory = match[1] === LAUNCHER_CATEGORY;\n      break;\n    }\n    // On older Android versions the category name\n    // might not be listed, so we just try to fetch\n    // all matches instead\n    if (hasCategory && !isLauncherCategory) {\n      continue;\n    }\n\n    for (const activityNameStr of item.map(_.trim).filter(Boolean)) {\n      const fqActivityName = activityNameStr.split(/\\s+/)[1];\n      if (!matchComponentName(fqActivityName)) {\n        continue;\n      }\n\n      if (isLauncherCategory) {\n        return [fqActivityName];\n      }\n      result.push(fqActivityName);\n    }\n  }\n  return result;\n}\n\n/**\n * Check if the given string is a valid component name\n *\n * @param {string} classString The string to verify\n * @return {?Array<Match>} The result of Regexp.exec operation\n * or _null_ if no matches are found\n */\nfunction matchComponentName (classString) {\n  // some.package/some.package.Activity\n  return /^[a-z0-9./_]+$/i.exec(classString);\n}\n\nexport {\n  getAndroidPlatformAndPath, unzipFile,\n  getIMEListFromOutput, getJavaForOs, isShowingLockscreen, isCurrentFocusOnKeyguard,\n  getSurfaceOrientation, isScreenOnFully, buildStartCmd, getJavaHome,\n  getSdkToolsVersion, getApksignerForOs, getBuildToolsDirs,\n  getApkanalyzerForOs, getOpenSslForOs, extractMatchingPermissions, APKS_EXTENSION,\n  APK_INSTALL_TIMEOUT, APKS_INSTALL_TIMEOUT, buildInstallArgs, APK_EXTENSION,\n  DEFAULT_ADB_EXEC_TIMEOUT, parseManifest, parseAaptStrings, parseAapt2Strings,\n  formatConfigMarker, parseJsonData, unsignApk, toAvdLocaleArgs, requireSdkRoot,\n  getSdkRootFromEnv, getAndroidPrefsRoot, dirExists, escapeShellArg,\n  parseLaunchableActivityNames, matchComponentName, getModuleRoot\n};\n"],"mappings":"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"}